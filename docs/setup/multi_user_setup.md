# Настройка многопользовательского режима

## Обзор

Бот теперь поддерживает многопользовательский режим с индивидуальными токенами ZenMoney для каждого пользователя.

## Процедура регистрации пользователя

### 1. Администратор добавляет пользователя

Администратор использует команду `/admin_add_user` для добавления нового пользователя в систему.

### 2. Пользователь запускает бота

Пользователь отправляет команду `/start` боту.

### 3. Проверка авторизации

Бот проверяет, есть ли пользователь в базе данных и активен ли он.

Если пользователь не авторизован, бот отвечает:
```
Ваш логин: [username]
Ваш Telegram ID: [telegram_id]

Перешлите это сообщение администратору, чтобы он добавил вас в группу тестирования
```

### 4. Настройка токена ZenMoney

Если пользователь не имеет токена, бот запрашивает его:
- Пользователь отправляет токен
- Бот валидирует токен через ZenMoney API
- Токен сохраняется в базе данных

### 5. Настройка данных

После успешной валидации токена бот предлагает:
- Загрузить статьи (теги) из ZenMoney
- Загрузить счета из ZenMoney
- Пропустить настройку

### 6. Завершение настройки

После загрузки данных или пропуска настройки бот показывает приветствие и готов к работе.

## Команды

### Для пользователей
- `/start` - запуск бота и настройка
- `/accounts` - показать счета
- `/accounts_upd` - обновить счета
- `/tags_upd` - обновить теги

### Для администраторов
- `/admin_add_user` - добавить нового пользователя

## Структура базы данных

### Таблица `users`
- `id` - уникальный идентификатор
- `telegram_id` - ID пользователя в Telegram
- `username` - имя пользователя в Telegram
- `first_name` - имя
- `last_name` - фамилия
- `zenmoney_token` - токен ZenMoney API
- `is_active` - активен ли пользователь
- `is_admin` - является ли администратором

### Таблица `user_settings`
- `user_id` - ID пользователя
- `parameter_name` - название параметра
- `parameter_value` - значение параметра

### Таблицы с данными ZenMoney
- `zm_accounts` - счета с привязкой к пользователю
- `zm_tags` - теги с привязкой к пользователю

## Безопасность

- RLS (Row Level Security) политики обеспечивают изоляцию данных
- Каждый пользователь видит только свои данные
- Токены валидируются перед сохранением
- Все действия логируются

## Миграция

Для перехода на многопользовательский режим:

1. Выполните SQL скрипт `multi_user_schema.sql`
2. Создайте первого администратора
3. Добавьте пользователей через команду `/admin_add_user`

## Примеры использования

### Добавление пользователя администратором
```
/admin_add_user 123456789 username Иван
```

### Настройка токена пользователем
1. Пользователь отправляет `/start`
2. Бот запрашивает токен
3. Пользователь отправляет токен
4. Бот валидирует и сохраняет токен

### Загрузка данных
1. Пользователь нажимает "Загрузить статьи"
2. Бот загружает теги из ZenMoney
3. Пользователь нажимает "Загрузить счета"
4. Бот загружает счета из ZenMoney
5. Настройка завершена

## Обработка ошибок

- Неверный токен - бот запрашивает новый
- Ошибка загрузки данных - показывается сообщение об ошибке
- Неавторизованный пользователь - сообщения игнорируются
- Проблемы с API - показывается соответствующее сообщение

## Логирование

Все действия пользователей логируются:
- Сообщения сохраняются в `user_messages`
- Транзакции сохраняются в `user_transactions`
- ИИ-запросы сохраняются в `user_ai_logs`
- Статистика ведется в `user_statistics`

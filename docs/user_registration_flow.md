# –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

## –°—Ü–µ–Ω–∞—Ä–∏–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

### 1. –ö–æ–º–∞–Ω–¥–∞ /start
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç –±–æ—Ç—É `/start`
- –ë–æ—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∏–º—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–∞–±–ª–∏—Ü–µ `users`
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –∏–ª–∏ –æ–Ω –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω, —Ç–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—Å—Ç—å –∏ –æ–Ω –∞–∫—Ç–∏–≤–µ–Ω, —Ç–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### 2. –ó–∞–ø—Ä–æ—Å —Ç–æ–∫–µ–Ω–∞ ZenMoney
- –ë–æ—Ç –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Ç–æ–∫–µ–Ω –¥–ª—è –∑–µ–Ω-–º–∞–Ω–∏:
```
üîë –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–æ—Ç–æ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º —Ç–æ–∫–µ–Ω ZenMoney API.

–û—Ç–ø—Ä–∞–≤—å—Ç–µ –≤–∞—à —Ç–æ–∫–µ–Ω ZenMoney –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞.
```

### 3. –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–ª—é—á
- –ë–æ—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:
  - —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ - —ç—Ç–æ –∫–ª—é—á
  - —á—Ç–æ —Å –ø–æ–º–æ—â—å—é –∫–ª—é—á–∞ –º–æ–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –∑–µ–Ω-–º–∞–Ω–∏
  - –µ—Å–ª–∏ –∫–ª—é—á —Ä–∞–±–æ—á–∏–π, —Ç–æ —Å–≤—è–∑—ã–≤–∞–µ—Ç –µ–≥–æ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
  - –µ—Å–ª–∏ –∫–ª—é—á –Ω–µ —Ä–∞–±–æ—á–∏–π, —Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Ä–∞–±–æ—á–∏–π –∫–ª—é—á

### 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ (–µ—Å–ª–∏ —Ç–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω)
- –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å —Ä–∞–±–æ—á–∏–π –∫–ª—é—á, —Ç–æ –±–æ—Ç –ø–∏—à–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –∏–Ω–ª–∞–π–Ω –∫–Ω–æ–ø–∫–∏:
  - –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç—å–∏ (—Ç–µ–≥–∏)
  - –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—á–µ—Ç–∞
  - –ø–µ—Ä–µ–π—Ç–∏ –¥–∞–ª—å—à–µ

### 5. –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–µ–π (—Ç–µ–≥–æ–≤)
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É "–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç—å–∏"
- –ë–æ—Ç –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Å—Ç–∞—Ç—å–∏ –∏ —Å–≤—è–∑—ã–≤–∞–µ—Ç –∏—Ö —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
- –ü–∏—à–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤

### 6. –ó–∞–≥—Ä—É–∑–∫–∞ —Å—á–µ—Ç–æ–≤
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É "–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—á–µ—Ç–∞"
- –ë–æ—Ç –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Å—á–µ—Ç–∞ –∏ —Å–≤—è–∑—ã–≤–∞–µ—Ç –∏—Ö —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
- –ü–∏—à–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤

### 7. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É "–ø–µ—Ä–µ–π—Ç–∏ –¥–∞–ª—å—à–µ"
- –ë–æ—Ç –ø–∏—à–µ—Ç –∫–∞–∫–æ–µ –∫–æ–ª-–≤–æ —Å—á–µ—Ç–æ–≤ –∏ —Å—Ç–∞—Ç–µ–π –∑–∞–≥—Ä—É–∂–µ–Ω–æ
- –ü—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —Å–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å —Ç–µ–∫—Å—Ç–æ–º, –∞ –ø–æ—Ç–æ–º –≥–æ–ª–æ—Å–æ–º

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
```sql
-- –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
users (
  id, telegram_id, username, first_name, last_name,
  zenmoney_token, is_active, is_admin,
  created_at, last_activity, updated_at
)

-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
user_settings (
  user_id, parameter_name, parameter_value
)

-- –°—á–µ—Ç–∞ —Å –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
zm_accounts (
  id, user_id, title, balance, type, ...
)

-- –¢–µ–≥–∏ —Å –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é  
zm_tags (
  id, user_id, title, parent_id, ...
)
```

### –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
```javascript
// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async function isUserAuthorized(telegramId, username)

// –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async function createOrUpdateUser(userData)

// –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞ ZenMoney
async function validateZenMoneyToken(token)

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–≥–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async function loadUserTags(userId, token)

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å—á–µ—Ç–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async function loadUserAccounts(userId, token)
```

### –°–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `pending_token` - –æ–∂–∏–¥–∞–µ—Ç —Ç–æ–∫–µ–Ω
- `token_validated` - —Ç–æ–∫–µ–Ω –ø—Ä–æ–≤–µ—Ä–µ–Ω, –Ω—É–∂–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
- `setup_complete` - –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
- `active` - –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ API

## –ü—Ä–∏–º–µ—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏–π

### –ó–∞–ø—Ä–æ—Å —Ç–æ–∫–µ–Ω–∞
```
üîë –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–æ—Ç–æ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º —Ç–æ–∫–µ–Ω ZenMoney API.

–û—Ç–ø—Ä–∞–≤—å—Ç–µ –≤–∞—à —Ç–æ–∫–µ–Ω ZenMoney –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞.
```

### –¢–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω
```
‚ùå –¢–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∏–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç.

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å —Ç–æ–∫–µ–Ω–∞ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.
```

### –¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω
```
‚úÖ –¢–æ–∫–µ–Ω —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!

–î–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:

üìã –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç—å–∏ (—Ç–µ–≥–∏) - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π
üí≥ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—á–µ—Ç–∞ - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å—á–µ—Ç–æ–≤
‚û°Ô∏è –ü–µ—Ä–µ–π—Ç–∏ –¥–∞–ª—å—à–µ - –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É
```

### –°—Ç–∞—Ç—å–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
```
üìã –°—Ç–∞—Ç—å–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!

–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å—Ç–∞—Ç–µ–π: 15
- –ü—Ä–æ–¥—É–∫—Ç—ã –ø–∏—Ç–∞–Ω–∏—è
- –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç
- –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è
- ...
```

### –°—á–µ—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
```
üí≥ –°—á–µ—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!

–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å—á–µ—Ç–æ–≤: 3
- –û—Å–Ω–æ–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ (45 230 ‚ÇΩ)
- –ù–∞–ª–∏—á–Ω—ã–µ (2 500 ‚ÇΩ)
- –°–±–µ—Ä–µ–≥–∞—Ç–µ–ª—å–Ω—ã–π —Å—á–µ—Ç (150 000 ‚ÇΩ)
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
```
üéâ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!

üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
- –°—Ç–∞—Ç–µ–π –∑–∞–≥—Ä—É–∂–µ–Ω–æ: 15
- –°—á–µ—Ç–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: 3

üí° –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ:
- –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- –ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏ —Å—á–µ—Ç

–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å: "–ü–æ—Ç—Ä–∞—Ç–∏–ª 500 —Ä—É–±–ª–µ–π –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç—ã –≤ –º–∞–≥–∞–∑–∏–Ω–µ"
```

### –°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä–≤–æ–π –∑–∞–ø–∏—Å–∏
```
üöÄ –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å!

–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –≤–∞—à–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä:
"–ü–æ—Ç—Ä–∞—Ç–∏–ª 500 —Ä—É–±–ª–µ–π –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç—ã"

–ò–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º —Ç—Ä–∞—Ç—ã.
```

## –ò–Ω–ª–∞–π–Ω –∫–Ω–æ–ø–∫–∏

### –ö–Ω–æ–ø–∫–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
```javascript
const setupKeyboard = [
  [
    { text: 'üìã –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç—å–∏', callback_data: 'load_tags' },
    { text: 'üí≥ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—á–µ—Ç–∞', callback_data: 'load_accounts' }
  ],
  [
    { text: '‚û°Ô∏è –ü–µ—Ä–µ–π—Ç–∏ –¥–∞–ª—å—à–µ', callback_data: 'skip_setup' }
  ]
];
```

## –û–±—Ä–∞–±–æ—Ç–∫–∞ callback'–æ–≤

### –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–≥–æ–≤
```javascript
if (callbackData === 'load_tags') {
  await handleLoadTags(chatId, userId, messageId);
}
```

### –ó–∞–≥—Ä—É–∑–∫–∞ —Å—á–µ—Ç–æ–≤
```javascript
if (callbackData === 'load_accounts') {
  await handleLoadAccounts(chatId, userId, messageId);
}
```

### –ü—Ä–æ–ø—É—Å–∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
```javascript
if (callbackData === 'skip_setup') {
  await handleSkipSetup(chatId, userId, messageId);
}
```

## –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞ ZenMoney

### –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
```javascript
async function validateZenMoneyToken(token) {
  try {
    const response = await axios.post('https://api.zenmoney.ru/v8/diff', {
      currentClientTimestamp: Math.floor(Date.now() / 1000),
      serverTimestamp: 0
    }, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      timeout: 10000
    });
    
    return { valid: true, data: response.data };
  } catch (error) {
    return { valid: false, error: error.message };
  }
}
```

## –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ ZenMoney

### –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–≥–æ–≤
```javascript
async function loadUserTags(userId, token) {
  try {
    const response = await axios.post('https://api.zenmoney.ru/v8/diff', {
      currentClientTimestamp: Math.floor(Date.now() / 1000),
      serverTimestamp: 0
    }, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });

    const tags = response.data.tag || {};
    const tagCount = Object.keys(tags).length;
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–≥–∏ –≤ zm_tags —Å user_id
    for (const [tagId, tagData] of Object.entries(tags)) {
      await supabaseClient.insertTag({
        id: tagId,
        user_id: userId,
        title: tagData.title,
        parent_id: tagData.parent,
        // ... –¥—Ä—É–≥–∏–µ –ø–æ–ª—è
      });
    }
    
    return { success: true, count: tagCount };
  } catch (error) {
    return { success: false, error: error.message };
  }
}
```

### –ó–∞–≥—Ä—É–∑–∫–∞ —Å—á–µ—Ç–æ–≤
```javascript
async function loadUserAccounts(userId, token) {
  try {
    const response = await axios.post('https://api.zenmoney.ru/v8/diff', {
      currentClientTimestamp: Math.floor(Date.now() / 1000),
      serverTimestamp: 0
    }, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });

    const accounts = response.data.account || {};
    const accountCount = Object.keys(accounts).length;
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—á–µ—Ç–∞ –≤ zm_accounts —Å user_id
    for (const [accountId, accountData] of Object.entries(accounts)) {
      await supabaseClient.insertAccount({
        id: accountId,
        user_id: userId,
        title: accountData.title,
        balance: accountData.balance,
        type: accountData.type,
        // ... –¥—Ä—É–≥–∏–µ –ø–æ–ª—è
      });
    }
    
    return { success: true, count: accountCount };
  } catch (error) {
    return { success: false, error: error.message };
  }
}
```

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```javascript
async function logUserAction(userId, action, details) {
  try {
    await supabaseClient.insertUserMessage({
      user_id: userId,
      message_type: 'system',
      original_text: `Action: ${action}, Details: ${JSON.stringify(details)}`,
      message_size: 0
    });
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–∏ –¥–µ–π—Å—Ç–≤–∏—è:', error.message);
  }
}
```

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–∞
```javascript
if (!tokenValidation.valid) {
  await bot.sendMessage(chatId, `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ç–æ–∫–µ–Ω–∞: ${tokenValidation.error}`, {
    reply_to_message_id: messageId
  });
  return;
}
```

### –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
```javascript
if (!loadResult.success) {
  await bot.sendMessage(chatId, `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ: ${loadResult.error}`, {
    reply_to_message_id: messageId
  });
  return;
}
```

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ handleStartCommand
```javascript
async function handleStartCommand(chatId, user, messageId) {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
  const authResult = await isUserAuthorized(user.id, user.username);
  
  if (!authResult.authorized) {
    console.log(`üö´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω: ${user.id}`);
    return;
  }
  
  const currentUser = authResult.user;
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞
  if (!currentUser.zenmoney_token) {
    await requestZenMoneyToken(chatId, currentUser, messageId);
    return;
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  if (currentUser.setup_status === 'pending') {
    await showSetupOptions(chatId, currentUser, messageId);
    return;
  }
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
  await showWelcomeMessage(chatId, currentUser, messageId);
}
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
```javascript
async function handleTextMessage(chatId, text, user, messageId) {
  const authResult = await isUserAuthorized(user.id, user.username);
  
  if (!authResult.authorized) {
    return;
  }
  
  const currentUser = authResult.user;
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ–∂–∏–¥–∞–µ—Ç—Å—è –ª–∏ —Ç–æ–∫–µ–Ω
  if (currentUser.setup_status === 'pending_token') {
    await handleTokenInput(chatId, text, currentUser, messageId);
    return;
  }
  
  // –û–±—ã—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
  await handleTransactionWithAI(chatId, text, user, messageId, currentUser);
}
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–∞
```javascript
describe('Token Validation', () => {
  test('should validate correct token', async () => {
    const result = await validateZenMoneyToken('valid_token');
    expect(result.valid).toBe(true);
  });
  
  test('should reject invalid token', async () => {
    const result = await validateZenMoneyToken('invalid_token');
    expect(result.valid).toBe(false);
  });
});
```

### –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
```javascript
describe('Data Loading', () => {
  test('should load user tags', async () => {
    const result = await loadUserTags(1, 'valid_token');
    expect(result.success).toBe(true);
    expect(result.count).toBeGreaterThan(0);
  });
  
  test('should load user accounts', async () => {
    const result = await loadUserAccounts(1, 'valid_token');
    expect(result.success).toBe(true);
    expect(result.count).toBeGreaterThan(0);
  });
});
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ú–µ—Ç—Ä–∏–∫–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –¥–µ–Ω—å
- –ü—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—à–Ω—ã—Ö —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–π
- –í—Ä–µ–º—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤

### –ê–ª–µ—Ä—Ç—ã
- –í—ã—Å–æ–∫–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- –ú–µ–¥–ª–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ ZenMoney
- –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
